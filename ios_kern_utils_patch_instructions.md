The [ios-kern-utils](https://github.com/Siguza/ios-kern-utils) are a set of
utilities that help with analysis of the XNU kernel on iOS and macOS. However,
in order to use these utilities, the kernel must be patched to allow the
`task_for_pid` function to obtain the kernel task (i.e. PID 0). On iOS, this is
typically done via a jailbreak. On macOS, the easiest way to do this is by
patching the kernel source and compiling it. 

First, modify the `task_for_pid` function in `bsd/vm/vm_unix.c` to remove the
check for `pid == 0`. In XNU-4570.1.46, this check is on line 780 (shown below).
Simply commenting it out, will allow the ios-kern-utils package to obtain the
task port for the kernel task.

```
/* Always check if pid == 0 */
 if (pid == 0) {
   (void ) copyout((char *)&t1, task_addr, sizeof(mach_port_name_t));
   AUDIT_MACH_SYSCALL_EXIT(KERN_FAILURE);
   return(KERN_FAILURE);
 }
```

The second required patch is to disable the restrictions on the kernel task. We
need to modify the `task_conversion_eval` function in `osfmk/kern/ipc_tt.c` (on
line 1350 in XNU-4570.1.46). This function checks whether our process is allowed
to obtain the ports for the kernel task. Modifying this function, so that it
always returns `KERN_SUCCESS` will disable these checks. An example change is
shown below:

```
kern_return_t
task_conversion_eval(task_t caller, task_t victim)
{
  (void)caller; //Get rid of the unused parameter error
  (void)victim;
  return KERN_SUCCESS;
}
```

Once you've made these changes and booted into the new kernel, the
[ios-kern-utils](https://github.com/Siguza/ios-kern-utils) source can be cloned
and compiled as normal. The utilities will require root (sudo) to run.


