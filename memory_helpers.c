#include <mach/mach.h>

#define MAX_CHUNK_SIZE 0xfff

vm_size_t task_read(task_t task, vm_address_t addr, vm_size_t size, void *buf)
{
    kern_return_t ret;
    vm_size_t remainder = size,
              bytes_read = 0;

    for(vm_address_t end = addr + size; addr < end; remainder -= size)
    {
        size = remainder > MAX_CHUNK_SIZE ? MAX_CHUNK_SIZE : remainder;
        ret = vm_read_overwrite(task, addr, size, (vm_address_t)((char*)buf + bytes_read), &size);
        if(ret != KERN_SUCCESS || size == 0)
        {
            break;
        }
        bytes_read += size;
        addr += size;
    }

    return bytes_read;
}

vm_size_t task_write(task_t task, vm_address_t addr, vm_size_t size, void *buf)
{
    kern_return_t ret;
    vm_size_t remainder = size;
    vm_size_t bytes_written = 0;

    for(vm_address_t end = addr + size; addr < end; remainder -= size)
    {
        size = remainder > MAX_CHUNK_SIZE ? MAX_CHUNK_SIZE : remainder;
        ret = vm_write(task, addr, (vm_offset_t)((char*)buf + bytes_written), size);
        if(ret != KERN_SUCCESS)
        {
            break;
        }
        bytes_written += size;
        addr += size;
    }

    return bytes_written;
}
